ActiveAdmin.register <%= report_run.name %> do
  menu false
  belongs_to <%= ":#{report.singular}" %>, optional: true
  actions :index, :show, :destroy

  includes %i[<%= admin_user.singular %> <%= report.singular %>]

  parent_info_line_1 = Proc.new do
    column :name do |report|
      div do
        span report.name
        br
        span link_to 'Show Code', show_code_admin_active_admin_report_path(report)
      end
    end
    column :description
    column :created_at
    column :updated_at
  end

  index(as: :table_with_info, content_blocks: { parent_content: parent_info_line_1 }) do
    selectable_column
    id_column
    column <%= ":#{report.singular}" %>
    column <%= ":#{admin_user.singular}" %>
    column :job_reference
    column(:run_status) do |run|
      status_tag run.run_status_completed?, label: run.run_status
    end
    column :ran_at
    actions
  end

  show do
    columns do
      column(max_width: '70%') do
        code do
          div(style: 'white-space: pre-wrap; overflow-wrap: break-word;') do
            resource.log
          end
        end
      end
      column do
        panel 'Report(s)' do
          resource.reports.map do |r|
            li a(href: r.url){ r.filename }
          end
        end
      end if resource.reports.present?
    end
  end

  sidebar('Info', only: :show) do
    attributes_table do
      rows <%= ":#{report.singular}" %>, <%= ":#{admin_user.singular}" %>, :ran_at, :created_at, :updated_at
    end
  end

  controller do
    include ActiveStorage::SetCurrent
  end
end
